name: Ubuntu RDP - Playit (Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ====================================================
      # 1. تثبيت واجهة سطح المكتب (XFCE) و XRDP
      # ====================================================
      - name: Install Desktop (XFCE) & XRDP
        run: |
          echo "Installing XFCE and XRDP..."
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
          # إعداد جلسة XFCE للمستخدم
          echo "xfce4-session" > ~/.xsession
          
          # تشغيل خدمة RDP
          sudo service xrdp start
          echo "XRDP Started successfully."

      # ====================================================
      # 2. إنشاء المستخدم وتعيين كلمة المرور
      # ====================================================
      - name: Create User & Password
        run: |
          # يمكنك تغيير الاسم والباسورد هنا
          USER_NAME="runner"
          USER_PASS="Zxxz4444"
          
          echo "Setting password for $USER_NAME..."
          echo "$USER_NAME:$USER_PASS" | sudo chpasswd
          
          # إضافة المستخدم لمجموعة sudo (اختياري)
          sudo usermod -aG sudo $USER_NAME
          echo "User configured."

      # ====================================================
      # 3. تحميل وتشغيل Playit (الرابط المصحح)
      # ====================================================
      - name: Setup Playit & Keep Alive
        run: |
          echo "Downloading Playit Agent..."
          # هذا هو الرابط الصحيح للنسخة المباشرة
          curl -L https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -o playit
          chmod +x playit
          
          echo "============================================="
          echo "             HOW TO CONNECT"
          echo "============================================="
          echo "1. Look for the CLAIM URL below (starts with https://playit.gg/claim/...)"
          echo "2. Click it and authorize in your browser."
          echo "3. Add a tunnel: Select 'Custom' -> Target: 127.0.0.1 -> Port: 3389"
          echo "4. Use the address Playit gives you to connect via RDP."
          echo "   User: runner"
          echo "   Pass: Zxxz4444"
          echo "============================================="
          
          # تشغيل Playit
          ./playit
